\documentclass[12pt,]{article}
\usepackage{lmodern}
\usepackage{amssymb,amsmath}
\usepackage{ifxetex,ifluatex}
\usepackage{fixltx2e} % provides \textsubscript
\ifnum 0\ifxetex 1\fi\ifluatex 1\fi=0 % if pdftex
  \usepackage[T1]{fontenc}
  \usepackage[utf8]{inputenc}
\else % if luatex or xelatex
  \ifxetex
    \usepackage{mathspec}
  \else
    \usepackage{fontspec}
  \fi
  \defaultfontfeatures{Ligatures=TeX,Scale=MatchLowercase}
    \setmonofont[Mapping=tex-ansi,Scale=0.7]{Ubuntu}
\fi
% use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
% use microtype if available
\IfFileExists{microtype.sty}{%
\usepackage{microtype}
\UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
}{}
\usepackage[margin=1in]{geometry}
\usepackage{hyperref}
\PassOptionsToPackage{usenames,dvipsnames}{color} % color is loaded by hyperref
\hypersetup{unicode=true,
            pdftitle={Dashboards project},
            pdfauthor={Richard White},
            colorlinks=true,
            linkcolor=Maroon,
            citecolor=Blue,
            urlcolor=Blue,
            breaklinks=true}
\urlstyle{same}  % don't use monospace font for urls
\usepackage{natbib}
\bibliographystyle{apalike}
\usepackage{longtable,booktabs}
\usepackage{graphicx,grffile}
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
% Scale images if necessary, so that they will not overflow the page
% margins by default, and it is still possible to overwrite the defaults
% using explicit options in \includegraphics[width, height, ...]{}
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}
\IfFileExists{parskip.sty}{%
\usepackage{parskip}
}{% else
\setlength{\parindent}{0pt}
\setlength{\parskip}{6pt plus 2pt minus 1pt}
}
\setlength{\emergencystretch}{3em}  % prevent overfull lines
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
\setcounter{secnumdepth}{5}
% Redefines (sub)paragraphs to behave more like sections
\ifx\paragraph\undefined\else
\let\oldparagraph\paragraph
\renewcommand{\paragraph}[1]{\oldparagraph{#1}\mbox{}}
\fi
\ifx\subparagraph\undefined\else
\let\oldsubparagraph\subparagraph
\renewcommand{\subparagraph}[1]{\oldsubparagraph{#1}\mbox{}}
\fi

%%% Use protect on footnotes to avoid problems with footnotes in titles
\let\rmarkdownfootnote\footnote%
\def\footnote{\protect\rmarkdownfootnote}

%%% Change title format to be more compact
\usepackage{titling}

% Create subtitle command for use in maketitle
\newcommand{\subtitle}[1]{
  \posttitle{
    \begin{center}\large#1\end{center}
    }
}

\setlength{\droptitle}{-2em}

  \title{Dashboards project}
    \pretitle{\vspace{\droptitle}\centering\huge}
  \posttitle{\par}
    \author{Richard White}
    \preauthor{\centering\large\emph}
  \postauthor{\par}
      \predate{\centering\large\emph}
  \postdate{\par}
    \date{2018-10-18}

\usepackage{booktabs}

\begin{document}
\maketitle

{
\hypersetup{linkcolor=black}
\setcounter{tocdepth}{2}
\tableofcontents
}
\listoftables
\listoffigures
\section{Introduction}\label{introduction}

\subsection{Executive summary}\label{executive-summary}

The dashboards project is a project at FHI concerned with running
automated analyses on data.

In principle, the dashboards project is split up into three parts:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  The overarching infrastructure (i.e.~Docker containers, continuous
  integration, chron jobs, etc.)
\item
  The R package for each automated analysis
\item
  Integrating the R package into the physical system (e.g.~specifying
  where the data is)
\end{enumerate}

\subsection{What is an automated
analysis?}\label{what-is-an-automated-analysis}

An automated analysis is any analysis that:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Will be repeated multiple times in the future
\item
  Always has an input dataset with consistent file structure
\item
  Always has the same expected output (e.g.~tables, graphs, reports)
\end{enumerate}

\subsection{Why not have one project for each automated
analysis?}\label{why-not-have-one-project-for-each-automated-analysis}

Automated analyses have a lot of code and infrastructure in common.

Automated analyses:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Need their code to be tested via unit testing to ensure the results
  are correct
\item
  Need their code to be tested via integration testing to ensure
  everything runs
\item
  Need to be run at certain times
\item
  Need to be able to send emails notifying people that the analyses have
  finished running
\item
  Need to make their results accessible to the relevant people
\end{enumerate}

By combining them all in one umbrella project we can force everyone to
use the same infrastructure and coding principles, so we:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Only need to solve a problem once
\item
  Only need to maintain one system
\item
  Can easily work on multiple projects, as we all speak the same
  language
\end{enumerate}

\subsection{Important repositories}\label{important-repositories}

\subsubsection{Infrastructure}\label{infrastructure}

\url{https://github.com/raubreywhite/dashboards_control/} (private)

This contains the Docker files, cronfiles, all bash scripts, etc.

\url{https://folkehelseinstituttet.github.io/dashboards/} (this one)

This contains the R executable for each automated analysis.

\url{https://folkehelseinstituttet.github.io/fhi/}

This is an R package that contains helper functions.

\subsubsection{Automated analyses}\label{automated-analyses}

\url{https://folkehelseinstituttet.github.io/dashboards_sykdomspuls/}

\url{https://folkehelseinstituttet.github.io/dashboards_normomo/}

\url{https://folkehelseinstituttet.github.io/dashboards_sykdomspuls_pdf/}

\url{https://folkehelseinstituttet.github.io/dashboards_sykdomspuls_log/}

\section{Integrating the R package into the physical
system}\label{integrating-the-r-package-into-the-physical-system}

\subsection{Summary}\label{summary}

An R package is not enough to run an analysis -- something needs to
physically call the functions inside the R package. That is, the R
package needs to be integrated into the physical system.

Everything related to integrating the R package into the physical system
lives in the
\href{https://github.com/folkehelseinstituttet/dashboards/}{dashboards}
repository.

Inside the
\href{https://github.com/folkehelseinstituttet/dashboards/}{dashboards}
repository we have:

\begin{verbatim}
- dev/
|-- src/
   |-- sykdomspuls/
      |-- 0_run.sh
      |-- RunProcess.R
      |-- RunTest.R
   |-- normomo/
      |-- 0_run.sh
      |-- RunProcess.R
      |-- RunTest.R
   |-- sykdomspuls_log/
      |-- 0_run.sh
      |-- RunProcess.R
      |-- RunTest.R
   |-- sykdomspuls_pdf/
      |-- 0_run.sh
      |-- RunProcess.R
      |-- RunTest.R
\end{verbatim}

\subsection{RunProcess.R}\label{runprocess.r}

\subsubsection{Purpose}\label{purpose}

An automated analysis needs to:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Know the location of the data/results folders.
\item
  Check for new data in these folders. If no new data - then quit.
\item
  Load in the data.
\item
  Load in the analysis functions.
\item
  Run the analyses.
\item
  Save the results.
\end{enumerate}

The R executable (commonly called \texttt{RunProcess.R}) is responsible
for these tasks.

We can think of it as an extremely short and extremely high-level script
that implements the analysis scripts.

Depending on the automated analysis, \texttt{RunProcess.R} can be run
every two minutes (constantly checking for new data), or once a week
(when we know that data will only be available on a certain day/time).

\subsubsection{Bounded context}\label{bounded-context}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Only one instance of \texttt{RunProcess.R} can be run at a time.
\item
  Data only exists on physical folders on the system.
\end{enumerate}

Point \#1 is important because if \texttt{RunProcess.R} is run every 2
minutes (constantly checking for new data) but the analyses take 3 hours
to run, then we need to ensure that only one instance of
\texttt{RunProcess.R} can be run at a time.

Point \#2 is important because sometimes:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Data files need to be downloaded from external SFTP servers
  (\href{https://folkehelseinstituttet.github.io/dashboards_normomo/}{normomo},
  \href{https://folkehelseinstituttet.github.io/dashboards_sykdomspuls_log/}{sykdomspuls\_log}).
\item
  Results files need to be uploaded to external SFTP servers
  \href{https://folkehelseinstituttet.github.io/dashboards_sykdomspuls/}{sykdomspuls}.
\end{enumerate}

If we include code to download/upload the files from SFTP servers inside
\texttt{RunProcess.R} then it makes it very difficult to test
\texttt{RunProcess.R} (because we will then need to simulate SFTP
servers inside our testing infrastructure). If we know that
\texttt{RunProcess.R} only accesses files that are available on physical
folders in the system, then our testing infrastructure is a lot easier
to create and maintain.

\subsection{0\_run.sh}\label{run.sh}

\subsubsection{Purpose}\label{purpose-1}

The aim of \texttt{0\_run.sh} is to ensure that:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  The bounded context of \texttt{RunProcess.R} happens
\item
  Run \texttt{RunProcess.R}
\end{enumerate}

Point \#1 is done through the use of \texttt{flock}.

(If neccessary) point \#2 uses \texttt{sshpass}, \texttt{sftp}, and
\texttt{ncftpput} to download/upload files from SFTP servers.

\subsection{RunTest.R}\label{runtest.r}

\section{R packages}\label{r-packages}

Each automated analysis has its own R package (e.g.
\href{https://github.com/folkehelseinstituttet/dashboards_sykdomspuls/}{sykdomspuls}).

Each R package should contain 99\%

\section{Introduction}\label{intro}

\subsection{Executive summary}\label{executive-summary-1}

The dashboards project is a project at FHI concerned with running
automated analyses on data.

In principle, the dashboards project is split up into three parts:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  The overarching infrastructure (i.e.~Docker containers, continuous
  integration, chron jobs, etc.)
\item
  The R package for each automated analysis
\item
  The executable for each automated analysis
\end{enumerate}

\subsection{What is an automated
analysis?}\label{what-is-an-automated-analysis-1}

An automated analysis is any analysis that:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Will be repeated multiple times in the future
\item
  Always has an input dataset with consistent file structure
\item
  Always has the same expected output (e.g.~tables, graphs, reports)
\end{enumerate}

\subsection{Why not have one project for each automated
analysis?}\label{why-not-have-one-project-for-each-automated-analysis-1}

Automated analyses have a lot of code and infrastructure in common.

Automated analyses:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Need their code to be tested via unit testing to ensure the results
  are correct
\item
  Need their code to be tested via integration testing to ensure
  everything runs
\item
  Need to be run at certain times
\item
  Need to be able to send emails notifying people that the analyses have
  finished running
\item
  Need to make their results accessible to the relevant people
\end{enumerate}

By combining them all in one umbrella project we can force everyone to
use the same infrastructure, so we:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Only need to solve a problem once
\item
  Only need to maintain one system
\item
  Can easily work on multiple projects, as we all speak the same
  language
\end{enumerate}

\bibliography{book.bib}


\end{document}
